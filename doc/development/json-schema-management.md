# Managing JSON schemas

We are using [JSON Schema draft 7](https://json-schema.org/).

## Extensions to the JSON Schema definition

We've extended the JSON schema with the following top-level fields:
 * **immutable (boolean)**: the property should not be changed after the object was created
 * **identifier (boolean)**: used to mark a unique (and required) identifier field on objects in an array

## Unmarshalling a JSON schema into a Go struct

We have a Go object generated for unmarshalling a schema definition:

```go
import "github.com/appvia/kore/pkg/utils/jsonschema"

schema := jsonschema.MetaSchemaDraft7Ext{}
if err := json.Unmarshal(schemaBytes, &schema); err != nil {
    // handle error
}
```

## Generating Go structs from JSON schemas

We use a fork of [schematyper](https://github.com/idubinskiy/schematyper) for generating Go structs from JSON schemas.

There is a helper command in `cmd/struct-gen`, which can be used with `go generate` to automatically convert inline JSON schema definitions to matching Go structs.

### Usage

You can define your JSON schema as a Go variable or constant.

**schema.go**
```go
package example

//go:generate go run github.com/appvia/kore/cmd/struct-gen MyStruct
const schema = `{
  [...]
}`
```

Running `go generate schema.go` will create the following file:

**schema_struct.go**
```go
// Code generated by struct-gen; DO NOT EDIT.

package example

type MyStruct struct {
	// [...]
}
```

## Validating Go objects using a JSON schema

```go
import "github.com/appvia/kore/pkg/utils/jsonschema"

if err := jsonschema.Validate(schemaString, "subject", object); err != nil {
  // handle error
}
```

## Validating immutable fields using a JSON schema

```go
import "github.com/appvia/kore/pkg/utils/jsonschema"

if err := jsonschema.ValidateImmutableProperties(
    schemaString,
    "subject",
    "validationFieldPrefix",
    existingObject,
    updatedObject,
); err != nil {
    // handle error
}
```

If you want to make sure objects in an array correctly compared (independently of the object order), you should have a
unique identifier field (e.g. `name`) set in the schema.

```json
{
    "type": "array",
    "items": {
        "type": "object",
        "required": ["name"],
        "properties": {
            "name": {"type": "string", "identifier": true },
            "address": {"type": "string"}
        }
    }
}
```
